import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { getCurrentUser, getUserDetails, getTodaysAppointments } from '../utils/api';

export function useAuth() {
    const navigate = useNavigate();
    const [user, setUser] = useState(null);
    const [appointments, setAppointments] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        async function loadData() {
            try {
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    navigate('/');
                    return;
                }

                let displayName = currentUser.username || 'User';
                let initials = displayName.substring(0, 2).toUpperCase();

                try {
                    const userDetails = await getUserDetails(currentUser.id);
                    if (userDetails && userDetails.fullName) {
                        displayName = userDetails.fullName;
                        const nameParts = displayName.split(' ');
                        initials = nameParts.length > 1
                        ? (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase()
                        : displayName.substring(0, 2).toUpperCase();
                    }
                } catch (error) {
                    console.log('Could not fetch user details, using username:', error);
                }

                setUser({
                    id: currentUser.id,
                    name: displayName,
                    initials,
                    role: 'user',
                    permissions: currentUser.scopes || [],
                    unreadMessages: 0
                });

                // TODO: wire real appointments
                // const appts = await getTodaysAppointments();
                // setAppointments(appts || []);
                setAppointments([]);

                setLoading(false);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                setLoading(false);
            }
        }

        loadData();
    }, [navigate]);

    return { user, appointments, loading };
}
