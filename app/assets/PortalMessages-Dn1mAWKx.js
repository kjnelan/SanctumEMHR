import{r as n,j as e,P as x,E as M,S as O}from"./index-BneZRaVW.js";import{u as U,P as A}from"./PortalLayout-tSnuzZag.js";import{M as k}from"./Modal-Cvs3YgFz.js";import"./PortalService-CisPuOln.js";import"./index-mWt39q-I.js";function H(){const{client:m}=U(),[p,T]=n.useState([]),[l,F]=n.useState(null),[g,L]=n.useState([]),[y,P]=n.useState(0),[R,j]=n.useState(!0),[i,a]=n.useState(""),[b,d]=n.useState(!1),[c,f]=n.useState(""),[N,v]=n.useState(!1),[o,u]=n.useState({subject:"",body:"",priority:"normal"}),h=async()=>{try{j(!0),a("");const s=await fetch("/custom/api/portal/messages/get_inbox.php?view=inbox",{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch messages");const t=await s.json();t.success?(T(t.messages||[]),P(t.unreadCount||0)):a(t.error||"Failed to load messages")}catch(s){console.error("Fetch messages error:",s),a("Failed to load messages")}finally{j(!1)}},w=async s=>{try{a("");const t=await fetch(`/custom/api/portal/messages/get_thread.php?thread_id=${s}`,{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch thread");const r=await t.json();r.success?(L(r.messages||[]),await _([s])):a(r.error||"Failed to load thread")}catch(t){console.error("Fetch thread error:",t),a("Failed to load thread")}},_=async s=>{try{await fetch("/custom/api/portal/messages/mark_read.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message_ids:s})}),h()}catch(t){console.error("Mark read error:",t)}},E=async()=>{if(!(!c.trim()||!l))try{v(!0),a("");const s=g[0],r=await(await fetch("/custom/api/portal/messages/send_message.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({thread_id:l,recipient_id:m.providerId,body:c,priority:"normal"})})).json();r.success?(f(""),await w(l)):a(r.error||"Failed to send reply")}catch(s){console.error("Send reply error:",s),a("Failed to send reply")}finally{v(!1)}},S=async s=>{s.preventDefault();try{a("");const r=await(await fetch("/custom/api/portal/messages/send_message.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({recipient_id:m.providerId,subject:o.subject,body:o.body,priority:o.priority})})).json();r.success?(d(!1),u({subject:"",body:"",priority:"normal"}),h()):a(r.error||"Failed to send message")}catch(t){console.error("Send message error:",t),a("Failed to send message")}};n.useEffect(()=>{h()},[]);const D=s=>{const t=new Date(s),C=new Date-t;return C<864e5?t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}):C<6048e5?t.toLocaleDateString("en-US",{weekday:"short"}):t.toLocaleDateString("en-US",{month:"short",day:"numeric"})};return e.jsx(A,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"sanctum-glass-main p-6",children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Messages"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Secure messaging with your care team"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[y>0&&e.jsxs("span",{className:"px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-full",children:[y," unread"]}),e.jsx(x,{onClick:()=>d(!0),children:"New Message"})]})]})}),i&&e.jsx(M,{children:i}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"sanctum-glass-main p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3",children:"My Messages"}),R?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading..."}):p.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("p",{children:"No messages yet"}),e.jsx("p",{className:"text-sm mt-2",children:"Send a message to your provider to get started"})]}):e.jsx("div",{className:"space-y-2",children:p.map(s=>e.jsxs("button",{onClick:()=>{F(s.id),w(s.id)},className:`w-full text-left p-3 rounded-lg transition-colors ${l===s.id?"bg-blue-100 border-2 border-blue-500":"bg-white/60 hover:bg-white/80 border border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsx("span",{className:`font-medium ${s.isRead?"text-gray-700":"text-gray-900 font-bold"}`,children:s.senderName||"Your Care Team"}),!s.isRead&&e.jsx("span",{className:"w-2 h-2 bg-blue-500 rounded-full"})]}),e.jsx("div",{className:"text-sm text-gray-600 font-medium mb-1",children:s.subject||"(No subject)"}),e.jsx("div",{className:"text-xs text-gray-500 truncate mb-1",children:s.preview}),e.jsx("div",{className:"flex items-center justify-between text-xs text-gray-500",children:e.jsx("span",{children:D(s.lastReplyAt||s.createdAt)})}),s.replyCount>0&&e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:[s.replyCount," ",s.replyCount===1?"reply":"replies"]})]},s.id))})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsx("div",{className:"sanctum-glass-main p-6",children:l?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:g.map((s,t)=>{const r=s.senderType==="client";return e.jsx("div",{className:`flex ${r?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xl ${r?"bg-blue-500 text-white":"bg-white"} rounded-lg p-4 shadow`,children:[t===0&&s.subject&&e.jsx("div",{className:"font-bold mb-2 pb-2 border-b border-white/20",children:s.subject}),e.jsx("div",{className:"flex items-start gap-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium mb-1",children:s.senderName}),e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:s.body}),e.jsx("div",{className:"text-xs mt-2 opacity-70",children:new Date(s.createdAt).toLocaleString()})]})})]})},s.id)})}),e.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[e.jsx("textarea",{value:c,onChange:s=>f(s.target.value),placeholder:"Type your reply...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",rows:"3"}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx(x,{onClick:E,disabled:!c.trim()||N,children:N?"Sending...":"Send Reply"})})]})]}):e.jsxs("div",{className:"text-center py-16 text-gray-500",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})}),e.jsx("p",{children:"Select a message to view the conversation"})]})})})]}),b&&e.jsxs(k,{isOpen:b,onClose:()=>d(!1),title:"New Message",size:"md",children:[e.jsxs("form",{onSubmit:S,className:"space-y-4",children:[i&&e.jsx(M,{children:i}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:e.jsxs("p",{className:"text-sm text-gray-700",children:[e.jsx("strong",{children:"To:"})," ",m.providerName||"Your Care Team"]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:o.subject,onChange:s=>u({...o,subject:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Message"}),e.jsx("textarea",{value:o.body,onChange:s=>u({...o,body:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none",rows:"6",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs("select",{value:o.priority,onChange:s=>u({...o,priority:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs(k.Footer,{children:[e.jsx(O,{onClick:()=>d(!1),children:"Cancel"}),e.jsx(x,{onClick:S,children:"Send Message"})]})]})]})})}export{H as default};
