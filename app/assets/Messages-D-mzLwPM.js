import{n as $,r as n,j as e,P as m,E as M,S as P}from"./index-CoZMK1aj.js";import{M as F}from"./Modal-C6HlD0cC.js";import"./index-rOZlxwqg.js";function J(){$();const[l,g]=n.useState("inbox"),[y,R]=n.useState([]),[c,I]=n.useState(null),[b,_]=n.useState([]),[f,L]=n.useState(0),[D,j]=n.useState(!0),[d,r]=n.useState(""),[N,u]=n.useState(!1),[x,v]=n.useState(""),[w,S]=n.useState(!1),[i,o]=n.useState({recipientType:"client",recipientId:"",subject:"",body:"",priority:"normal"}),h=async()=>{try{j(!0),r("");const s=await fetch(`/custom/api/messages/get_inbox.php?view=${l}`,{credentials:"include"});if(!s.ok)throw new Error("Failed to fetch messages");const t=await s.json();t.success?(R(t.messages||[]),L(t.unreadCount||0)):r(t.error||"Failed to load messages")}catch(s){console.error("Fetch messages error:",s),r("Failed to load messages")}finally{j(!1)}},C=async s=>{try{r("");const t=await fetch(`/custom/api/messages/get_thread.php?thread_id=${s}`,{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch thread");const a=await t.json();a.success?(_(a.messages||[]),await E([s])):r(a.error||"Failed to load thread")}catch(t){console.error("Fetch thread error:",t),r("Failed to load thread")}},E=async s=>{try{await fetch("/custom/api/messages/mark_read.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({message_ids:s})}),h()}catch(t){console.error("Mark read error:",t)}},O=async()=>{if(!(!x.trim()||!c))try{S(!0),r("");const s=b[0],t=s.senderType==="staff",a=t?s.recipientType:s.senderType,p=t?s.recipientType==="client"?s.recipientClientId:s.recipientUserId:s.senderType==="client"?s.senderClientId:s.senderUserId,k=await(await fetch("/custom/api/messages/send_message.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({thread_id:c,recipient_type:a,recipient_id:p,body:x,priority:"normal"})})).json();k.success?(v(""),await C(c)):r(k.error||"Failed to send reply")}catch(s){console.error("Send reply error:",s),r("Failed to send reply")}finally{S(!1)}},T=async s=>{s.preventDefault();try{r("");const a=await(await fetch("/custom/api/messages/send_message.php",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(i)})).json();a.success?(u(!1),o({recipientType:"client",recipientId:"",subject:"",body:"",priority:"normal"}),h()):r(a.error||"Failed to send message")}catch(t){console.error("Send message error:",t),r("Failed to send message")}};n.useEffect(()=>{h()},[l]);const U=s=>{const t=new Date(s),p=new Date-t;return p<864e5?t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}):p<6048e5?t.toLocaleDateString("en-US",{weekday:"short"}):t.toLocaleDateString("en-US",{month:"short",day:"numeric"})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"sanctum-glass-main p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-800",children:"Messages"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Secure messaging with clients and staff"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[f>0&&e.jsxs("span",{className:"px-3 py-1 bg-red-500 text-white text-sm font-semibold rounded-full",children:[f," unread"]}),e.jsx(m,{onClick:()=>u(!0),children:"New Message"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>g("inbox"),className:`px-4 py-2 rounded-lg font-medium transition-colors ${l==="inbox"?"bg-blue-500 text-white":"bg-white/60 text-gray-700 hover:bg-white/80"}`,children:"Inbox"}),e.jsx("button",{onClick:()=>g("sent"),className:`px-4 py-2 rounded-lg font-medium transition-colors ${l==="sent"?"bg-blue-500 text-white":"bg-white/60 text-gray-700 hover:bg-white/80"}`,children:"Sent"})]})]}),d&&e.jsx(M,{children:d}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"sanctum-glass-main p-4",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3",children:l==="inbox"?"Received":"Sent"}),D?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading..."}):y.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No messages"}):e.jsx("div",{className:"space-y-2",children:y.map(s=>e.jsxs("button",{onClick:()=>{I(s.id),C(s.id)},className:`w-full text-left p-3 rounded-lg transition-colors ${c===s.id?"bg-blue-100 border-2 border-blue-500":"bg-white/60 hover:bg-white/80 border border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsx("span",{className:`font-medium ${s.isRead?"text-gray-700":"text-gray-900 font-bold"}`,children:l==="inbox"?s.senderName:s.recipientName}),!s.isRead&&e.jsx("span",{className:"w-2 h-2 bg-blue-500 rounded-full"})]}),e.jsx("div",{className:"text-sm text-gray-600 font-medium mb-1",children:s.subject||"(No subject)"}),e.jsx("div",{className:"text-xs text-gray-500 truncate mb-1",children:s.preview}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[e.jsx("span",{children:s.clientName}),e.jsx("span",{children:U(s.lastReplyAt||s.createdAt)})]}),s.replyCount>0&&e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:[s.replyCount," ",s.replyCount===1?"reply":"replies"]})]},s.id))})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsx("div",{className:"sanctum-glass-main p-6",children:c?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:b.map((s,t)=>{const a=s.senderType==="staff";return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xl ${a?"bg-blue-500 text-white":"bg-white"} rounded-lg p-4 shadow`,children:[t===0&&s.subject&&e.jsx("div",{className:"font-bold mb-2 pb-2 border-b border-white/20",children:s.subject}),e.jsx("div",{className:"flex items-start gap-3",children:e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium mb-1",children:s.senderName}),e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:s.body}),e.jsx("div",{className:"text-xs mt-2 opacity-70",children:new Date(s.createdAt).toLocaleString()})]})})]})},s.id)})}),e.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[e.jsx("textarea",{value:x,onChange:s=>v(s.target.value),placeholder:"Type your reply...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",rows:"3"}),e.jsx("div",{className:"flex justify-end mt-2",children:e.jsx(m,{onClick:O,disabled:!x.trim()||w,children:w?"Sending...":"Send Reply"})})]})]}):e.jsxs("div",{className:"text-center py-16 text-gray-500",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"})}),e.jsx("p",{children:"Select a message to view the conversation"})]})})})]}),N&&e.jsxs(F,{isOpen:N,onClose:()=>u(!1),title:"New Message",size:"md",children:[e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[d&&e.jsx(M,{children:d}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Recipient Type"}),e.jsxs("select",{value:i.recipientType,onChange:s=>o({...i,recipientType:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"client",children:"Client"}),e.jsx("option",{value:"staff",children:"Staff"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Recipient ID"}),e.jsx("input",{type:"number",value:i.recipientId,onChange:s=>o({...i,recipientId:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Subject"}),e.jsx("input",{type:"text",value:i.subject,onChange:s=>o({...i,subject:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Message"}),e.jsx("textarea",{value:i.body,onChange:s=>o({...i,body:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 resize-none",rows:"6",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority"}),e.jsxs("select",{value:i.priority,onChange:s=>o({...i,priority:s.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),e.jsxs(F.Footer,{children:[e.jsx(P,{onClick:()=>u(!1),children:"Cancel"}),e.jsx(m,{onClick:T,children:"Send Message"})]})]})]})}export{J as default};
